# UPTC EcoEnergy - Zero-Configuration Docker Compose
# This is the ONLY file you need for Dokploy deployment
# NO environment variables required - everything is pre-configured below

version: '3.8'

services:
  # PostgreSQL with TimescaleDB - Fully pre-configured
  database:
    image: timescale/timescaledb:latest-pg15
    container_name: uptc_database
    environment:
      POSTGRES_DB: uptc_energy
      POSTGRES_USER: uptc_user
      POSTGRES_PASSWORD: uptc_password_2024
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/init_db.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./init-data.sh:/docker-entrypoint-initdb.d/02-init-data.sh
    networks:
      - uptc_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U uptc_user -d uptc_energy"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Data Loader - Automatically populates database with 275K records
  data-loader:
    build:
      context: ./backend
      dockerfile: Dockerfile.data-loader
    container_name: uptc_data_loader
    environment:
      DATABASE_URL: postgresql+asyncpg://uptc_user:uptc_password_2024@database:5432/uptc_energy
      CSV_PATH: /data/consumos_uptc.csv
    volumes:
      - ./consumos_uptc_hackday:/data:ro
    networks:
      - uptc_network
    depends_on:
      database:
        condition: service_healthy
    restart: "no"
    deploy:
      restart_policy:
        condition: none

  # FastAPI Backend - Fully configured with OpenAI
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        OPENAI_API_KEY: "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"
    container_name: uptc_backend
    environment:
      DATABASE_URL: postgresql+asyncpg://uptc_user:uptc_password_2024@database:5432/uptc_energy
      DEBUG: "false"
      CORS_ORIGINS_STR: "*"
      OPENAI_API_KEY: "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"
    ports:
      - "8000:8000"
    networks:
      - uptc_network
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
      data-loader:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # Next.js Frontend - Fully configured
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: /api
        NEXT_PUBLIC_WS_URL: ws://localhost:8000/ws
    container_name: uptc_frontend
    environment:
      NEXT_PUBLIC_API_URL: /api
      NEXT_PUBLIC_WS_URL: ws://localhost:8000/ws
    ports:
      - "3000:3000"
    networks:
      - uptc_network
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Telegram Bot - Fully configured with OpenAI and Telegram Token
  # Token: 8343621647:AAEE5OROMpUI2nOG5aA3YMuttg-zNwWteHM
  telegram-bot:
    build:
      context: ./telegram_bot
      dockerfile: Dockerfile
      args:
        OPENAI_API_KEY: "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"
    container_name: uptc_telegram_bot
    environment:
      OPENAI_API_KEY: "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"
      TELEGRAM_BOT_TOKEN: "8343621647:AAEE5OROMpUI2nOG5aA3YMuttg-zNwWteHM"
      API_BASE_URL: http://backend:8000/api/v1
    networks:
      - uptc_network
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    command: ["python", "app.py"]

volumes:
  postgres_data:
    name: uptc_postgres_data

networks:
  uptc_network:
    name: uptc_network
    driver: bridge
